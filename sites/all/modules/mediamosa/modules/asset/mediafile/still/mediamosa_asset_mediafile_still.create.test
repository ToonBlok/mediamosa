<?php
/**
 * @file
 * MediaMosa still watermark unittests.
 */

class MediaMosaAssetMediafileStillCreateTestCase extends MediaMosaTestCaseEgaJob {

  public static function getInfo() {
    return array(
      'name' => 'Still - Creation tests',
      'description' => 'Create and generate tests.',
      'group' => MEDIAMOSA_TEST_GROUP_MEDIAMOSA_CORE_STILL,
      mediamosa_settings::MEDIAMOSA_RUN => mediamosa_settings::MEDIAMOSA_RUN_DAILY,
    );
  }

  function setUp() {
    // Get from outside sandbox.
    $mediamosa_jobscheduler_uri = variable_get('mediamosa_jobscheduler_uri', NULL);

    // Run parent first so we are inside sandbox.
    // Call parent::setUp and preserve arguments.
    $args = func_get_args();

    // Create and setup the CORE module.
    $args = array_unique(array_merge(array('mediamosa_messenger'), $args));
    if (drupal_substr(phpversion(), 0, 3) < '5.3') {
      call_user_func_array(array($this, 'parent::setUp'), $args);
    }
    else {
      call_user_func_array('parent::setUp', $args);
    }

    // Set jobserver selection.
    if (!empty($mediamosa_jobscheduler_uri)) {
      variable_set('mediamosa_jobscheduler_uri', $mediamosa_jobscheduler_uri);
    }

    $this->core_types = [
      ['TRANSCODE'],
      ['SCHEDULER'],
      ['STILL'],
    ];
    $this->start_jobcores($this->core_types);
//    sleep(10);
    $servers_are_online = $this->wait_jobcores_online($this->core_types);
    $this->assert($servers_are_online, 'Servers required for unit tests are online');
  }

  /**
   * The still upload test.
   */
  function testStillCreate() {
    $upload = $this->uploadTestFile(array('downloadable' => TRUE));
    $asset_id = $upload['asset_id'];
    $mediafile_id = $upload['mediafile_id'];

    // Create transcode job.
    $this->createMediafileTranscode($mediafile_id, array('profile_id' => $this->getDefaultTranscodeProfile()));

    // Parse the queue.
    $this->doQueueCycleAll(FALSE, FALSE);

    // Get all stills, expecting none.
    $stills = $this->getAssetStill($asset_id, array(), array(mediamosa_error::ERRORCODE_STILL_NOT_FOUND));
    $this->var_export($stills, 'stills 1a');

    // Get all stills, expecting none.
    $stills = $this->getMediafileStill($mediafile_id, array(), array(mediamosa_error::ERRORCODE_STILL_NOT_FOUND));
    $this->var_export($stills, 'stills 1b');

    // Create a still.
    $this->createAssetStill($asset_id, $mediafile_id);

    // Parse the queue.
    $this->doQueueCycleAll(FALSE, FALSE);

    // Get all stills, expecting none.
    $stills = $this->getAssetStill($asset_id);
    $this->var_export($stills, 'stills 2a');

    // Expecting 1 still.
    // Actually have 5 stills now
    $this->assertTrue(count($stills) === 1, 'Found 1 still');


//    $this->var_export($stills);
//    $this->var_export($stills[0]['stills'][0]['width']);
//    $this->var_export($stills[0]['stills'][1]['width']);

    // Must be default size.
    list($width, $height) = explode('x', mediamosa_settings::STILL_DEFAULT_SIZE);
    $this->assertTrue($stills[0]['stills'][0]['width'] == $width, 'Width correct size');
    $this->assertTrue($stills[0]['stills'][0]['height'] == $height, 'Height correct size');

    // Get all stills.
    $stills = $this->getMediafileStill($mediafile_id);
    $this->var_export($stills, 'stills 2b');

    // Expecting 1 still.
    $this->assertTrue(count($stills) === 1, 'Found 1 still');

    // Must be default size.
    list($width, $height) = explode('x', mediamosa_settings::STILL_DEFAULT_SIZE);
    $this->assertTrue($stills[0]['stills'][0]['width'] == $width, 'Width correct size');
    $this->assertTrue($stills[0]['stills'][0]['height'] == $height, 'Height correct size');

    // Remove the still.
    $this->deleteStill($asset_id);

    // Get all stills, expecting none.
    $stills = $this->getAssetStill($asset_id, array(), array(mediamosa_error::ERRORCODE_STILL_NOT_FOUND));
    $this->var_export($stills, 'stills 3a');

    // Get all stills, expecting none.
    $stills = $this->getMediafileStill($mediafile_id, array(), array(mediamosa_error::ERRORCODE_STILL_NOT_FOUND));
    $this->var_export($stills, 'stills 3b');

    $width /= 2;
    $height /= 2;

    // Now generate still with smaller size.
    $this->createAssetStill($asset_id, $mediafile_id, array(mediamosa_rest_call_job_create_still::SIZE => $width . 'x' . $height));

    // Parse the queue.
    $this->doQueueCycleAll(FALSE, FALSE);

    // Get all stills.
    $stills = $this->getAssetStill($asset_id, array('size' => $width . 'x' . $height));
    $this->var_export($stills, 'stills 4a');

    // Check against new width.
    $this->assertTrue($stills[0]['stills'][0]['width'] == $width, 'Width correct size');
    $this->assertTrue($stills[0]['stills'][0]['height'] == $height, 'Height correct size');

    // Get all stills.
    $stills = $this->getMediafileStill($mediafile_id, array('size' => $width . 'x' . $height));
    $this->var_export($stills, 'stills 4b');

    // Check against new width.
    $this->assertTrue($stills[0]['stills'][0]['width'] == $width, 'Width correct size');
    $this->assertTrue($stills[0]['stills'][0]['height'] == $height, 'Height correct size');
  }
}
