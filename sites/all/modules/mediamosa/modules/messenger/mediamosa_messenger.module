<?php

// Alles hier moet met een underscore beginnen

/**
 * Implements hook_cron().
 */
function mediamosa_messenger_cron() {
  mediamosa_messenger_call_guardian();
}

/**
 * Implements hook_menu(). or does it?
 */
function _mediamosa_messenger_cron()
{
  mediamosa_debug::log('SUCCESS', array(), 'T - MISC');
//  mediamosa_messenger_call_guardian();
}

function mediamosa_messenger_call_guardian(){
  $installation_id = variable_get('mediamosa_installation_id');
  $core_types = variable_get('mediamosa_cores');
  mediamosa_debug::log('Cores: ' . count($core_types), array(), 'T - MISC');

  for ($i = 0; $i < count($core_types); $i++) {
    $core_type = $core_types[$i][0]; // HAS TO BE 0 for now because for now only 1 task
    mediamosa_debug::log('Core_type: ' . $core_type, array(), 'T - MISC');

    $query_data = [
      mediamosa_scheduler_start::QUEUE => $core_type,
      mediamosa_scheduler_start::QUEUE_KEEPALIVE_SERVER => $core_type . '_' . $installation_id . '_' . $i, // The scheduler needs this to know what to listen to for keepalive message
      mediamosa_scheduler_start::CORE_TYPE => $core_type,
    ];

    mediamosa_debug::log('Query data prepared for core: ' . serialize($query_data), array(), 'T - MISC');

    $uri = '/guardian/check?' . http_build_query($query_data);

    mediamosa_messenger_call($uri);
  }
}

function mediamosa_messenger_call($uri, array $query_data = array()) {
  $mediamosa_jobscheduler_uri = variable_get('mediamosa_jobscheduler_uri', NULL);

  if (isset($mediamosa_jobscheduler_uri)) {
    $uri = $uri . http_build_query($query_data);
    $url = mediamosa_http::uri2url($mediamosa_jobscheduler_uri) . $uri;

    mediamosa_http::do_head_internal_call($url);

    mediamosa_debug::log('Did REST call to: ' . $url, array(), 'T - REST');
  } else {
    mediamosa_job_scheduler::log('Jobscheduler URL not set, please setup jobscheduler server in the @link.', array('@link' => l(t('MediaMosa configuration'), 'admin/mediamosa/config/global')), WATCHDOG_ALERT, 'job_cron');
  }
}

/**
 * Implements hook_mediamosa_register_rest_call().
 */
function mediamosa_messenger_mediamosa_register_rest_call()
{
  $rest_calls = array();

  $rest_calls['jobcore/start'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::CLASS_NAME => 'mediamosa_messenger_jobcore',
    mediamosa_rest_call::STATUS => mediamosa_rest_call::STATUS_ACTIVE,
    mediamosa_rest_call::MODULE_NAME => 'mediamosa_messenger',
    mediamosa_rest_call::VERSION => mediamosa_version::MEDIAMOSA_VERSION_3_6_0,
    mediamosa_rest_call::BEHAVE_AS_EXTERNAL => TRUE,
    mediamosa_rest_call::ACCESS => mediamosa_rest_call::ACCESS_FOR_EXTERNAL,
  );

  $rest_calls['scheduler/start'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::CLASS_NAME => 'mediamosa_scheduler_start',
    mediamosa_rest_call::STATUS => mediamosa_rest_call::STATUS_ACTIVE,
    mediamosa_rest_call::MODULE_NAME => 'mediamosa_messenger',
    mediamosa_rest_call::VERSION => mediamosa_version::MEDIAMOSA_VERSION_3_6_0,
    mediamosa_rest_call::BEHAVE_AS_EXTERNAL => TRUE,
    mediamosa_rest_call::ACCESS => mediamosa_rest_call::ACCESS_FOR_EXTERNAL,
  );

  $rest_calls['scheduler/start_job'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::CLASS_NAME => 'mediamosa_scheduler_job_start',
    mediamosa_rest_call::STATUS => mediamosa_rest_call::STATUS_ACTIVE,
    mediamosa_rest_call::MODULE_NAME => 'mediamosa_messenger',
    mediamosa_rest_call::VERSION => mediamosa_version::MEDIAMOSA_VERSION_3_6_0,
    mediamosa_rest_call::BEHAVE_AS_EXTERNAL => TRUE,
    mediamosa_rest_call::ACCESS => mediamosa_rest_call::ACCESS_FOR_EXTERNAL,
  );

  $rest_calls['guardian/check'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::CLASS_NAME => 'mediamosa_messenger_guardian',
    mediamosa_rest_call::STATUS => mediamosa_rest_call::STATUS_ACTIVE,
    mediamosa_rest_call::MODULE_NAME => 'mediamosa_messenger',
    mediamosa_rest_call::VERSION => mediamosa_version::MEDIAMOSA_VERSION_3_6_0,
    mediamosa_rest_call::BEHAVE_AS_EXTERNAL => TRUE,
    mediamosa_rest_call::ACCESS => mediamosa_rest_call::ACCESS_FOR_EXTERNAL,
  );

  return $rest_calls;
}

function mediamosa_messenger_menu() {
  $items = array();
  $items['manualcron'] = array(
    'title' => 'Manual cron',
    'description' => '...',
    'access callback' => TRUE,
    'page callback' => '_mediamosa_messenger_cron',
    //'file' => 'mediamosa_messenger.module'
  );
  return $items;
}


